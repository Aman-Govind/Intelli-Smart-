<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>The Smart Room Energy Manager</title>
    <meta name="theme-color" content="#28a745" />
    <meta name="color-scheme" content="light" />
    <style>
      html{background:#ffffff}
      body{background:#ffffff}
      /* Minimal critical styles to avoid initial blackout before CSS loads */
      .intro-overlay{position:fixed;inset:0;display:grid;place-items:center;background:linear-gradient(180deg, rgba(255,255,255,0.96), rgba(247,250,249,0.98));z-index:50}
      .intro-content{opacity:1;transition:opacity .4s ease}
      .intro-overlay.hidden{opacity:0;visibility:hidden;transition:opacity .4s ease, visibility .4s ease}
    </style>
    <link rel="stylesheet" href="styles.css" />

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />

    <script defer src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  </head>
  <body>
    <div id="root">
    <div id="intro" class="intro-overlay" aria-hidden="true" style="background:linear-gradient(180deg, rgba(255,255,255,0.96), rgba(247,250,249,0.98))">
      <div class="intro-content">
        <div class="intro-logo">
          <svg viewBox="0 0 64 64" width="72" height="72" xmlns="http://www.w3.org/2000/svg" class="spin-pulse">
            <defs>
              <linearGradient id="ig" x1="0" y1="0" x2="1" y2="1">
                <stop offset="0%" stop-color="#28a745" />
                <stop offset="100%" stop-color="#1e90ff" />
              </linearGradient>
            </defs>
            <circle cx="32" cy="32" r="28" fill="url(#ig)" opacity="0.12" />
            <path d="M18 40c6-12 22-12 28 0" stroke="#28a745" stroke-width="3" fill="none" stroke-linecap="round" />
            <path d="M22 32c5-8 15-8 20 0" stroke="#1e90ff" stroke-width="3" fill="none" stroke-linecap="round" />
            <circle cx="32" cy="32" r="3" fill="#28a745" />
          </svg>
        </div>
        <h2 class="intro-title">The Smart Room Energy Manager</h2>
        <p class="intro-sub">Loading live data…</p>
      </div>
    </div>
    <div id="dashboard" style="display:none;">
    <header class="topnav">
      <div class="nav-left">
        <button id="menuToggle" class="hamburger" aria-label="Open navigation" aria-expanded="false">
          <span></span><span></span><span></span>
        </button>
        <div class="brand">
          <div class="logo" aria-hidden="true">
            <svg viewBox="0 0 36 36" width="28" height="28" xmlns="http://www.w3.org/2000/svg">
              <defs>
                <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
                  <stop offset="0%" stop-color="#28a745" />
                  <stop offset="100%" stop-color="#1e90ff" />
                </linearGradient>
              </defs>
              <circle cx="18" cy="18" r="16" fill="url(#g)" opacity="0.15" />
              <path d="M9 22c4-8 14-8 18 0" stroke="#28a745" stroke-width="2" fill="none" stroke-linecap="round" />
              <path d="M12 18c3-5 9-5 12 0" stroke="#1e90ff" stroke-width="2" fill="none" stroke-linecap="round" />
              <circle cx="18" cy="18" r="2" fill="#28a745" />
            </svg>
          </div>
          <h1 class="title">The Smart Room Energy Manager</h1>
        </div>
      </div>
      <nav class="nav-center" id="primaryNav">
        <a href="index.html" class="nav-link active">Dashboard</a>
        <a href="fan.html" class="nav-link">Fan</a>
        <a href="light.html" class="nav-link">Light</a>
      </nav>
      <div class="nav-right">
        <button id="refreshBtn" class="refresh-btn" title="Refresh data" aria-label="Refresh">Refresh</button>
        <button class="icon-btn" title="Search" aria-label="Search">
          <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="#ffffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
        </button>
        <button class="icon-btn" title="Settings" aria-label="Settings">
          <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="#ffffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 8 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 3.6 15a1.65 1.65 0 0 0-1.51-1H2a2 2 0 1 1 0-4h.09A1.65 1.65 0 0 0 3.6 8a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 8 3.6a1.65 1.65 0 0 0 1-1.51V2a2 2 0 1 1 4 0v.09A1.65 1.65 0 0 0 15 3.6a1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 20.4 8c0 .6.24 1.17.66 1.6.42.43.66 1 .66 1.6s-.24 1.17-.66 1.6A1.65 1.65 0 0 0 19.4 15z"/></svg>
        </button>
        <div class="avatar" title="Profile" aria-label="Profile"></div>
      </div>
    </header>
      <div class="brand">
        <div class="logo" aria-hidden="true">
          <svg viewBox="0 0 36 36" width="28" height="28" xmlns="http://www.w3.org/2000/svg">
            <defs>
              <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
                <stop offset="0%" stop-color="#28a745" />
                <stop offset="100%" stop-color="#1e90ff" />
              </linearGradient>
            </defs>
            <circle cx="18" cy="18" r="16" fill="url(#g)" opacity="0.15" />
            <path d="M9 22c4-8 14-8 18 0" stroke="#28a745" stroke-width="2" fill="none" stroke-linecap="round" />
            <path d="M12 18c3-5 9-5 12 0" stroke="#1e90ff" stroke-width="2" fill="none" stroke-linecap="round" />
            <circle cx="18" cy="18" r="2" fill="#28a745" />
          </svg>
        </div>
        <div class="title-group">
          <h1 class="title">The Smart Room Energy Manager</h1>
          <p class="subtitle">Real‑time insights and control</p>
        </div>
      </div>
      <nav class="nav-actions">
        <button id="refreshBtn" class="btn ghost" title="Refresh data">Refresh</button>
      </nav>
    </header>

    <main class="container">
      <section class="grid">
        <article class="card motion" id="card-motion">
          <div class="card-header">
            <div class="icon motion-wave" aria-hidden="true">
              <span class="wave"></span>
              <span class="wave"></span>
              <span class="wave"></span>
            </div>
            <h2>Motion Detection</h2>
          </div>
          <div class="card-content">
            <div class="value-row">
              <span id="motionStatus" class="value badge off">OFF</span>
            </div>
            <p class="muted">Updates instantly when motion is detected</p>
          </div>
        </article>

        <article class="card th">
          <div class="card-header">
            <div class="icon thermometer" aria-hidden="true"></div>
            <h2>Temperature & Humidity</h2>
          </div>
          <div class="card-content two-col">
            <div class="metric">
              <div class="label">Temperature</div>
              <div class="value" id="tempValue">— °C</div>
            </div>
            <div class="metric">
              <div class="label">Humidity</div>
              <div class="value" id="humValue">— %</div>
            </div>
          </div>
          <p class="muted">Source: DHT22 sensor</p>
        </article>

        <article class="card current">
          <div class="card-header">
            <div class="icon bolt" aria-hidden="true"></div>
            <h2>Current Usage</h2>
          </div>
          <div class="card-content">
            <div class="value-row">
              <div class="value" id="currentValue">— A</div>
            </div>
            <p class="muted">Sensor: ACS712</p>
          </div>
        </article>

        <article class="card energy">
          <div class="card-header">
            <div class="icon energy" aria-hidden="true"></div>
            <h2>Total Energy</h2>
          </div>
          <div class="card-content">
            <div class="value-row">
              <div class="value" id="energyValue">— kWh</div>
            </div>
            <p class="muted">Cumulative consumption</p>
          </div>
        </article>
      </section>

      <section class="panel">
        <div class="panel-header">
          <h3>Live Usage</h3>
          <div class="legend">
            <span class="dot green"></span>
            <span>Current (A)</span>
          </div>
        </div>
        <canvas id="usageChart" height="110"></canvas>
      </section>

      <section class="controls panel">
        <div class="panel-header">
          <h3>Controls</h3>
          <p class="muted">Toggle appliances remotely</p>
        </div>
        <div class="switches">
          <label class="switch">
            <input type="checkbox" id="toggleFan" />
            <span class="slider"></span>
            <span class="switch-label">Fan</span>
          </label>
          <label class="switch">
            <input type="checkbox" id="toggleLights" />
            <span class="slider"></span>
            <span class="switch-label">Lights</span>
          </label>
          <label class="switch">
            <input type="checkbox" id="toggleSockets" />
            <span class="slider"></span>
            <span class="switch-label">Sockets</span>
          </label>
        </div>
      </section>
    </main>

    <footer class="app-footer">
      <span>© <span id="year"></span> Smart Room Energy Manager</span>
      <a class="link" href="#" title="Project README">Docs</a>
    </footer>
    </div>
    </div>

    <script>
      window.addEventListener('DOMContentLoaded', () => {
      const formatNumber = (n, digits = 2) => {
        const num = Number(n);
        if (Number.isNaN(num)) return '—';
        return num.toLocaleString(undefined, { maximumFractionDigits: digits, minimumFractionDigits: digits });
      };

      document.getElementById('year').textContent = new Date().getFullYear();

      const usageCtx = document.getElementById('usageChart').getContext('2d');
      const usageData = {
        labels: [],
        datasets: [
          {
            label: 'Current (A)',
            data: [],
            tension: 0.35,
            borderColor: '#28a745',
            backgroundColor: 'rgba(40, 167, 69, 0.08)',
            fill: true,
            pointRadius: 0,
          },
        ],
      };
      const usageChart = new Chart(usageCtx, {
        type: 'line',
        data: usageData,
        options: {
          responsive: true,
          maintainAspectRatio: false,
          animation: { duration: 300 },
          scales: {
            x: { display: true, ticks: { color: '#6b7280' }, grid: { display: false } },
            y: { display: true, ticks: { color: '#6b7280' }, grid: { color: 'rgba(0,0,0,0.06)' } },
          },
          plugins: {
            legend: { display: false },
            tooltip: { mode: 'index', intersect: false },
          },
        },
      });

      function appendUsagePoint(valueA) {
        const now = new Date();
        const label = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        const MAX_POINTS = 60;
        usageData.labels.push(label);
        usageData.datasets[0].data.push(Number(valueA));
        if (usageData.labels.length > MAX_POINTS) {
          usageData.labels.shift();
          usageData.datasets[0].data.shift();
        }
        usageChart.update('none');
      }

      const el = {
        motionStatus: document.getElementById('motionStatus'),
        tempValue: document.getElementById('tempValue'),
        humValue: document.getElementById('humValue'),
        currentValue: document.getElementById('currentValue'),
        energyValue: document.getElementById('energyValue'),
        toggleFan: document.getElementById('toggleFan'),
        toggleLights: document.getElementById('toggleLights'),
        toggleSockets: document.getElementById('toggleSockets'),
        refreshBtn: document.getElementById('refreshBtn'),
        cardMotion: document.getElementById('card-motion'),
      };

      function setMotionUI(isOn) {
        el.motionStatus.textContent = isOn ? 'ON' : 'OFF';
        el.motionStatus.classList.toggle('on', !!isOn);
        el.motionStatus.classList.toggle('off', !isOn);
        el.cardMotion.classList.toggle('active', !!isOn);
      }

      // Intro overlay control
      const introEl = document.getElementById('intro');
      const dashboardEl = document.getElementById('dashboard');
      let introHidden = false;
      function hideIntro(reason) {
        if (introHidden) return;
        introHidden = true;
        if (!introEl) return;
        introEl.classList.add('hidden');
        setTimeout(() => {
          try { introEl.remove(); } catch(e) {}
          if (dashboardEl) dashboardEl.style.display = 'block';
        }, 450);
      }

      const firebaseConfig = {
        apiKey: 'YOUR_API_KEY',
        authDomain: 'YOUR_AUTH_DOMAIN',
        databaseURL: 'YOUR_DATABASE_URL',
        projectId: 'YOUR_PROJECT_ID',
        storageBucket: 'YOUR_STORAGE_BUCKET',
        messagingSenderId: 'YOUR_SENDER_ID',
        appId: 'YOUR_APP_ID',
      };

      let app, db, rtdb;
      try {
        app = firebase.initializeApp(firebaseConfig);
        rtdb = firebase.database();
        db = firebase.firestore();
      } catch (e) {
        console.warn('Firebase init skipped or failed. Populate config to enable live data.', e);
      }

      const paths = {
        motion: 'sensors/motion',
        dht: 'sensors/dht22',
        current: 'sensors/acs712',
        energy: 'sensors/energy',
        controls: 'controls',
      };

      let listenersBound = false;
      function bindRealtimeListeners() {
        if (!rtdb || listenersBound) return;
        listenersBound = true;
        rtdb.ref(paths.motion).on('value', (snap) => {
          const data = snap.val();
          setMotionUI(Boolean(data && (data.value ?? data)));
          hideIntro('motion');
        });

        rtdb.ref(paths.dht).on('value', (snap) => {
          const d = snap.val() || {};
          el.tempValue.textContent = `${formatNumber(d.temperature)} °C`;
          el.humValue.textContent = `${formatNumber(d.humidity)} %`;
          hideIntro('dht');
        });

        rtdb.ref(paths.current).on('value', (snap) => {
          const d = snap.val() || {};
          const amps = Number(d.current);
          el.currentValue.textContent = `${formatNumber(amps, 3)} A`;
          if (!Number.isNaN(amps)) appendUsagePoint(amps);
          hideIntro('current');
        });

        rtdb.ref(paths.energy).on('value', (snap) => {
          const d = snap.val() || {};
          el.energyValue.textContent = `${formatNumber(d.kwh)} kWh`;
          hideIntro('energy');
        });

        rtdb.ref(paths.controls).on('value', (snap) => {
          const d = snap.val() || {};
          el.toggleFan.checked = !!d.fan;
          el.toggleLights.checked = !!d.lights;
          el.toggleSockets.checked = !!d.sockets;
          hideIntro('controls');
        });
      }

      function writeControl(key, value) {
        if (!rtdb) return;
        rtdb.ref(paths.controls).update({ [key]: !!value }).catch(console.error);
      }

      el.toggleFan.addEventListener('change', (e) => writeControl('fan', e.target.checked));
      el.toggleLights.addEventListener('change', (e) => writeControl('lights', e.target.checked));
      el.toggleSockets.addEventListener('change', (e) => writeControl('sockets', e.target.checked));

      el.refreshBtn.addEventListener('click', async () => {
        if (!rtdb) return;
        const [m, d, c, en, ctl] = await Promise.all([
          rtdb.ref(paths.motion).get(),
          rtdb.ref(paths.dht).get(),
          rtdb.ref(paths.current).get(),
          rtdb.ref(paths.energy).get(),
          rtdb.ref(paths.controls).get(),
        ]);
        const mv = m.val();
        setMotionUI(Boolean(mv && (mv.value ?? mv)));
        const dv = d.val() || {};
        el.tempValue.textContent = `${formatNumber(dv.temperature)} °C`;
        el.humValue.textContent = `${formatNumber(dv.humidity)} %`;
        const cv = c.val() || {};
        const amps = Number(cv.current);
        el.currentValue.textContent = `${formatNumber(amps, 3)} A`;
        if (!Number.isNaN(amps)) appendUsagePoint(amps);
        const ev = en.val() || {};
        el.energyValue.textContent = `${formatNumber(ev.kwh)} kWh`;
        const ctlv = ctl.val() || {};
        el.toggleFan.checked = !!ctlv.fan;
        el.toggleLights.checked = !!ctlv.lights;
        el.toggleSockets.checked = !!ctlv.sockets;
      });

      // Hide intro if no data after timeout (prevents stuck splash)
      setTimeout(() => hideIntro('timeout'), 2500);

      bindRealtimeListeners();
      });
    </script>
    <script>
      // Mobile menu toggle
      (function(){
        const toggle = document.getElementById('menuToggle');
        const nav = document.getElementById('primaryNav');
        if (!toggle || !nav) return;
        toggle.addEventListener('click', () => {
          const open = nav.classList.toggle('open');
          toggle.setAttribute('aria-expanded', open ? 'true' : 'false');
        });
      })();
    </script>
  </body>
</html>

